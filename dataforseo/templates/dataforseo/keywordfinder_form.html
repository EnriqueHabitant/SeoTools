{% extends 'core/main.html' %}
{% load dataforseo_extras %}
{% block title %}Habitant Seo{% endblock %}

{% block content %}
<section class="section">
  <div class="container"> 
    <form id="keywordFinder" action="{% url 'dataforseo:keywordsearch' %}" method="post">{% csrf_token %}
      <div class="field">
        <label class="label">{{form.keyword.label}}:</label>
        <div class="control">
          {{form.keyword}}
        </div>
      </div>
      
      <div class="field is-grouped">
        <label class="label" for="">{{form.language.label}}</label>
        <div class="select">
          {{form.language}}
        </div>
      
        <label class="label" for="">{{form.limit.label}}</label>
        <div class="control">
          {{form.limit}}
        </div>
      
        <label class="label" for="">{{form.depth.label}}</label>
        <div class="control">
          {{form.depth}}
        </div>
      </div>

      <div class="field is-grouped is-grouped-right">
        <div class="control">
          <button id="send_keywordFinder" class="button is-link">Enviar</button>
        </div>
      </div>

      <div class="">
        {{form.method}}
        {{form.filters}}
        {{form.result}}
      </div>
    </form>
    <script>
      document.querySelectorAll('#id_language option').forEach((e) => e.text === 'es/ES' ? e.selected = true : '')
      document.querySelector('#send_keywordFinder').addEventListener('click', () => {
        event.preventDefault()
        const form = document.querySelector('#keywordFinder')
        const dataForm = new FormData(form)
        const lang = dataForm.get('language').split('/')

        // /keyword-search/related_keywords/[KEYWORD]/[COUNTRY_CODE]/[LANGUAGE_CODE]/[DEPTH]/[LIMIT]/
        const url = `http://127.0.0.1:8000/keyword-search/related_keywords/${dataForm.get('keyword')}/${lang[0]}/${lang[1]}/${dataForm.get('depth')}/${dataForm.get('limit')}/`
        fetch(url)
          .then(data => data.json())
          .then(data => {
            form.querySelector('#id_result').value = JSON.stringify(data)
          })
          .then(() => form.submit())
      })
    </script>
  </div>
</section>

  {% for method in resultado %}
    <section class="section">
      <table class="table">
        <thead>
          <tr>
            <th><abbr title="Keyword">Keyword</abbr></th>
            <th><abbr title="Search Volume">Search Volume</abbr></th>
            <th><abbr title="Competition">Competition</abbr></th>
            <th><abbr title="CPC">CPC</abbr></th>
            {% for fecha in meses_atras %}
              <th><abbr title="{{fecha}}">{{fecha}}</abbr></th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
        {% for res in method.items %}
          <tr>
            <td>{{res.keyword}}</td>
            <td>{{res.keyword_info.search_volume}}</td>
            <td>{{res.keyword_info.competition|ifnumbrefloat:2}}</td>
            <td>{{res.keyword_info.cpc|ifnumbrefloat:2}}</td>

            {% comment %} Resultados ordenados {% endcomment %}
            {% for das in meses_atras|get_value:res.keyword_info.monthly_searches %}
              <td>{{das}}</td>
            {% endfor %}

          </tr>
        {% endfor %}
        </tbody>
      </table>
    </section>
  {% endfor %}
{% endblock content %}